---
title: Database Schema
description: Complete database schema and table structure
---

## Overview

The database uses a relational model with four main tables:

- **projects** - Multi-tenant project management
- **users** - Visitor tracking and identification
- **sessions** - Session management with 30-minute timeout
- **pageviews** - Individual page visit records
- **events** - Custom event tracking

## Tables

### projects

Manages multiple projects with API key authentication.

```sql
CREATE TABLE projects (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  domain TEXT,
  api_key TEXT UNIQUE NOT NULL,
  is_active BOOLEAN DEFAULT true NOT NULL,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW() NOT NULL
);

CREATE UNIQUE INDEX projects_api_key_idx ON projects(api_key);
CREATE INDEX projects_domain_idx ON projects(domain);
```

**Fields:**
- `id` - Auto-incrementing primary key
- `name` - Project display name
- `domain` - Associated domain (optional)
- `api_key` - Unique authentication key
- `is_active` - Enable/disable tracking
- `created_at` - Creation timestamp
- `updated_at` - Last update timestamp

### users

Tracks unique visitors with device and location data.

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  fingerprint TEXT,
  first_seen TIMESTAMP DEFAULT NOW() NOT NULL,
  last_seen TIMESTAMP DEFAULT NOW() NOT NULL,
  device TEXT,
  browser TEXT,
  browser_version TEXT,
  os TEXT,
  os_version TEXT,
  country TEXT,
  region TEXT,
  city TEXT,
  lat REAL,
  lng REAL,
  timezone TEXT,
  language TEXT,
  is_dev BOOLEAN DEFAULT false NOT NULL
);

CREATE INDEX users_project_id_idx ON users(project_id);
CREATE INDEX users_fingerprint_idx ON users(fingerprint);
CREATE INDEX users_last_seen_idx ON users(last_seen);
```

**Fields:**
- `id` - UUID primary key
- `project_id` - Foreign key to projects table
- `fingerprint` - Browser fingerprint hash
- `first_seen` - First visit timestamp
- `last_seen` - Most recent visit timestamp
- `device` - Device type (desktop, mobile, tablet)
- `browser` - Browser name and version
- `browser_version` - Specific browser version
- `os` - Operating system
- `os_version` - OS version
- `country` - ISO country code
- `region` - State/province
- `city` - City name
- `lat` - Latitude coordinate
- `lng` - Longitude coordinate
- `timezone` - User timezone
- `language` - Browser language
- `is_dev` - Mark as developer traffic

### sessions

Tracks user sessions with referrer and UTM data.

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  started_at TIMESTAMP DEFAULT NOW() NOT NULL,
  ended_at TIMESTAMP,
  duration INTEGER,
  page_count INTEGER DEFAULT 0 NOT NULL,
  referrer TEXT,
  referrer_domain TEXT,
  landing_page TEXT,
  exit_page TEXT,
  origin TEXT,
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,
  utm_term TEXT,
  utm_content TEXT,
  device_type TEXT
);

CREATE INDEX sessions_user_id_idx ON sessions(user_id);
CREATE INDEX sessions_started_at_idx ON sessions(started_at);
CREATE INDEX sessions_ended_at_idx ON sessions(ended_at);
```

**Fields:**
- `id` - UUID primary key
- `user_id` - Foreign key to users table
- `started_at` - Session start time
- `ended_at` - Session end time (null if active)
- `duration` - Total session duration in seconds
- `page_count` - Number of pages visited
- `referrer` - Full referrer URL
- `referrer_domain` - Extracted referrer domain
- `landing_page` - First page visited
- `exit_page` - Last page visited
- `origin` - Traffic origin (direct, google, facebook, etc.)
- `utm_source` - UTM campaign source
- `utm_medium` - UTM campaign medium
- `utm_campaign` - UTM campaign name
- `utm_term` - UTM campaign term
- `utm_content` - UTM campaign content
- `device_type` - Device categorization

### pageviews

Records individual page visits with engagement metrics.

```sql
CREATE TABLE pageviews (
  id SERIAL PRIMARY KEY,
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  url TEXT NOT NULL,
  path TEXT NOT NULL,
  query_params TEXT,
  hash TEXT,
  title TEXT,
  timestamp TIMESTAMP DEFAULT NOW() NOT NULL,
  time_on_page INTEGER,
  scroll_depth INTEGER,
  clicks INTEGER DEFAULT 0 NOT NULL,
  is_exit BOOLEAN DEFAULT false NOT NULL
);

CREATE INDEX pageviews_session_id_idx ON pageviews(session_id);
CREATE INDEX pageviews_timestamp_idx ON pageviews(timestamp);
CREATE INDEX pageviews_path_idx ON pageviews(path);
```

**Fields:**
- `id` - Auto-incrementing primary key
- `session_id` - Foreign key to sessions table
- `url` - Full page URL
- `path` - URL pathname
- `query_params` - URL query string
- `hash` - URL hash fragment
- `title` - Page title
- `timestamp` - Visit timestamp
- `time_on_page` - Duration in milliseconds
- `scroll_depth` - Percentage scrolled (0-100)
- `clicks` - Number of clicks on page
- `is_exit` - Whether this was the exit page

### events

Custom event tracking for user interactions.

```sql
CREATE TABLE events (
  id SERIAL PRIMARY KEY,
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  category TEXT,
  action TEXT,
  label TEXT,
  value REAL,
  properties TEXT,
  timestamp TIMESTAMP DEFAULT NOW() NOT NULL
);

CREATE INDEX events_session_id_idx ON events(session_id);
CREATE INDEX events_name_idx ON events(name);
CREATE INDEX events_timestamp_idx ON events(timestamp);
```

**Fields:**
- `id` - Auto-incrementing primary key
- `session_id` - Foreign key to sessions table
- `name` - Event name
- `category` - Event category
- `action` - Event action
- `label` - Event label
- `value` - Numeric event value
- `properties` - JSON string of additional properties
- `timestamp` - Event timestamp

## Relationships

```
projects
  └── users (1:N)
       └── sessions (1:N)
            ├── pageviews (1:N)
            └── events (1:N)
```

- One project has many users
- One user has many sessions
- One session has many pageviews
- One session has many events

## Indexes

All tables include optimized indexes for:

- Primary key lookups
- Foreign key joins
- Timestamp range queries
- Frequent aggregation columns

## Data Retention

Cascading deletes ensure referential integrity:

- Deleting a project removes all associated users
- Deleting a user removes all associated sessions
- Deleting a session removes all associated pageviews and events

## Migration Commands

```bash
# Generate migration files
pnpm db:generate

# Apply migrations
pnpm db:migrate

# Reset database (development only)
pnpm db:reset
```
