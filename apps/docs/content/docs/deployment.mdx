---
title: Deployment
description: Production deployment guide for HONO Analytics
---

# Deployment

This guide covers deploying HONO Analytics to production environments including traditional servers, Docker, and edge platforms.

## Production Checklist

Before deploying to production:

- [ ] Set up PostgreSQL database
- [ ] Configure environment variables
- [ ] Generate secure API keys
- [ ] Set up SSL certificates
- [ ] Configure CORS for production domains
- [ ] Set up monitoring and logging
- [ ] Plan backup strategy

## Environment Variables

### Backend Production Environment

```bash path=/.env.production start=null
NODE_ENV=production
PORT=8000
DATABASE_URL=postgresql://user:secure_password@prod-db:5432/analytics
DEFAULT_API_KEY=prod-secure-api-key-123
LOG_LEVEL=warn
```

### Frontend Production Environment

```bash path=/.env.production start=null
NEXT_PUBLIC_ANALYTICS_API_KEY=prod-secure-api-key-123
NEXT_PUBLIC_ANALYTICS_PROJECT_ID=production-project
NEXT_PUBLIC_ANALYTICS_ENDPOINT=https://analytics.yourdomain.com
```

## Node.js Deployment

### Manual Deployment

1. **Prepare the server:**

```bash
# Install Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Install PM2 for process management
npm install -g pm2
```

2. **Clone and build:**

```bash
git clone https://github.com/your-org/hono-analytics.git
cd hono-analytics
npm install -g pnpm
pnpm install

cd packages/backend
pnpm build
```

3. **Set up database:**

```bash
# Run migrations
pnpm db:migrate

# Verify setup
pnpm db:check
```

4. **Start with PM2:**

```bash
# Create PM2 ecosystem file
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'hono-analytics',
    script: 'dist/server.js',
    cwd: './packages/backend',
    instances: 'max',
    exec_mode: 'cluster',
    env_production: {
      NODE_ENV: 'production',
      PORT: 8000,
      DATABASE_URL: 'postgresql://user:pass@localhost:5432/analytics',
      DEFAULT_API_KEY: 'your-secure-key'
    }
  }]
}
EOF

# Start application
pm2 start ecosystem.config.js --env production
pm2 save
pm2 startup
```

### Systemd Service

Create a systemd service for automatic startup:

```bash
sudo tee /etc/systemd/system/hono-analytics.service << 'EOF'
[Unit]
Description=HONO Analytics API
After=network.target postgresql.service

[Service]
Type=simple
User=analytics
WorkingDirectory=/opt/hono-analytics/packages/backend
ExecStart=/usr/bin/node dist/server.js
Restart=always
Environment=NODE_ENV=production
Environment=PORT=8000
Environment=DATABASE_URL=postgresql://user:pass@localhost:5432/analytics
Environment=DEFAULT_API_KEY=your-secure-key

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable hono-analytics
sudo systemctl start hono-analytics
```

## Docker Deployment

### Dockerfile

```dockerfile path=/Dockerfile start=null
FROM node:18-alpine AS builder

WORKDIR /app
COPY package.json pnpm-lock.yaml ./
COPY packages/backend/package.json ./packages/backend/

RUN npm install -g pnpm
RUN pnpm install --frozen-lockfile

COPY packages/backend ./packages/backend
RUN cd packages/backend && pnpm build

FROM node:18-alpine AS runtime

WORKDIR /app
COPY --from=builder /app/packages/backend/dist ./
COPY --from=builder /app/packages/backend/package.json ./
COPY --from=builder /app/node_modules ./node_modules

EXPOSE 8000

CMD ["node", "server.js"]
```

### Docker Compose

```yaml path=/docker-compose.yml start=null
version: '3.8'

services:
  analytics:
    build: .
    environment:
      - NODE_ENV=production
      - PORT=8000
      - DATABASE_URL=postgresql://analytics:analytics@db:5432/analytics
      - DEFAULT_API_KEY=${API_KEY:-secure-default-key}
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=analytics
      - POSTGRES_USER=analytics
      - POSTGRES_PASSWORD=${DB_PASSWORD:-analytics}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U analytics"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - analytics
    restart: unless-stopped

volumes:
  postgres_data:
```

### Environment File

```bash path=/.env start=null
API_KEY=your-super-secure-api-key-here
DB_PASSWORD=your-super-secure-db-password
```

### Deploy with Docker

```bash
# Build and start
docker-compose up -d

# Run migrations
docker-compose exec analytics node -e "
  require('dotenv').config()
  const { migrate } = require('./migrate')
  migrate().then(() => console.log('Migrations complete'))
"

# View logs
docker-compose logs -f analytics
```

## Cloud Deployments

### Vercel Edge Functions

For serverless deployment on Vercel:

```javascript path=/api/analytics.js start=null
import { app } from '../packages/backend/src/server.js'

export default app
```

Vercel configuration:

```json path=/vercel.json start=null
{
  "functions": {
    "api/analytics.js": {
      "runtime": "@vercel/node"
    }
  },
  "rewrites": [
    {
      "source": "/api/(.*)",
      "destination": "/api/analytics"
    }
  ],
  "env": {
    "DATABASE_URL": "@database_url",
    "DEFAULT_API_KEY": "@api_key"
  }
}
```

### Railway

Deploy to Railway with one command:

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login and deploy
railway login
railway link
railway up
```

Railway configuration:

```json path=/railway.json start=null
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "cd packages/backend && pnpm start",
    "healthcheckPath": "/health"
  }
}
```

### DigitalOcean App Platform

```yaml path=/.do/app.yaml start=null
name: hono-analytics
services:
- name: api
  source_dir: packages/backend
  github:
    repo: your-org/hono-analytics
    branch: main
  run_command: pnpm start
  build_command: pnpm build
  environment_slug: node-js
  instance_count: 1
  instance_size_slug: basic-xxs
  envs:
  - key: NODE_ENV
    value: production
  - key: DATABASE_URL
    type: SECRET
  - key: DEFAULT_API_KEY
    type: SECRET
databases:
- name: analytics-db
  engine: PG
  version: "15"
```

## Reverse Proxy Setup

### Nginx Configuration

```nginx path=/etc/nginx/sites-available/analytics start=null
upstream analytics_backend {
    server 127.0.0.1:8000;
    keepalive 32;
}

server {
    listen 80;
    server_name analytics.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name analytics.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/analytics.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/analytics.yourdomain.com/privkey.pem;
    
    location / {
        proxy_pass http://analytics_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    location /health {
        access_log off;
        proxy_pass http://analytics_backend/health;
    }
}
```

### SSL with Let's Encrypt

```bash
# Install certbot
sudo apt install certbot python3-certbot-nginx

# Get certificate
sudo certbot --nginx -d analytics.yourdomain.com

# Auto-renewal
sudo crontab -e
# Add: 0 12 * * * /usr/bin/certbot renew --quiet
```

## Frontend Deployment

### Next.js Production Build

```bash
# Build the application
cd apps/example
pnpm build
pnpm start

# Or static export
pnpm build
pnpm export
```

### Static Site Deployment

Deploy to Netlify, Vercel, or similar:

```json path=/next.config.js start=null
const nextConfig = {
  output: 'export',
  trailingSlash: true,
  images: {
    unoptimized: true
  },
  env: {
    NEXT_PUBLIC_ANALYTICS_API_KEY: process.env.NEXT_PUBLIC_ANALYTICS_API_KEY,
    NEXT_PUBLIC_ANALYTICS_PROJECT_ID: process.env.NEXT_PUBLIC_ANALYTICS_PROJECT_ID,
    NEXT_PUBLIC_ANALYTICS_ENDPOINT: process.env.NEXT_PUBLIC_ANALYTICS_ENDPOINT
  }
}

module.exports = nextConfig
```

## Monitoring and Logging

### Health Checks

Set up health monitoring:

```bash
# Simple health check script
curl -f https://analytics.yourdomain.com/health || exit 1

# Add to crontab for monitoring
*/5 * * * * /path/to/health-check.sh
```

### Application Monitoring

```javascript path=null start=null
function setupMonitoring(app) {
  app.use('*', async (c, next) => {
    const start = Date.now()
    await next()
    const duration = Date.now() - start
    
    console.log({
      method: c.req.method,
      url: c.req.url,
      status: c.res.status,
      duration,
      timestamp: new Date().toISOString()
    })
  })
}
```

### Error Tracking

Integrate with error tracking services:

```javascript path=null start=null
import * as Sentry from '@sentry/node'

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV
})

app.onError((error, c) => {
  Sentry.captureException(error)
  return c.json({ error: 'Internal server error' }, 500)
})
```

## Database Scaling

### Connection Pooling

```javascript path=null start=null
import { Pool } from 'pg'

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
})
```

### Read Replicas

For high-traffic deployments:

```javascript path=null start=null
const readPool = new Pool({
  connectionString: process.env.DATABASE_READ_URL,
  max: 10
})

const writePool = new Pool({
  connectionString: process.env.DATABASE_WRITE_URL,
  max: 5
})

function getConnection(readOnly = false) {
  return readOnly ? readPool : writePool
}
```

## Security Hardening

### Environment Security

```bash
# Create dedicated user
sudo useradd -r -s /bin/false analytics

# Set file permissions
sudo chown -R analytics:analytics /opt/hono-analytics
sudo chmod 750 /opt/hono-analytics

# Environment file security
sudo chmod 600 .env
sudo chown analytics:analytics .env
```

### API Security

```javascript path=null start=null
function setupSecurity(app) {
  app.use('*', cors({
    origin: process.env.ALLOWED_ORIGINS?.split(',') || [],
    credentials: false
  }))
  
  app.use('*', async (c, next) => {
    c.res.headers.set('X-Frame-Options', 'DENY')
    c.res.headers.set('X-Content-Type-Options', 'nosniff')
    c.res.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
    await next()
  })
}
```

## Backup Strategy

### Database Backups

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/analytics"
BACKUP_FILE="analytics_$(date +%Y%m%d_%H%M%S).sql"

mkdir -p $BACKUP_DIR

pg_dump $DATABASE_URL > "$BACKUP_DIR/$BACKUP_FILE"
gzip "$BACKUP_DIR/$BACKUP_FILE"

# Keep only last 7 days
find $BACKUP_DIR -name "analytics_*.sql.gz" -mtime +7 -delete

# Upload to S3 (optional)
aws s3 cp "$BACKUP_DIR/$BACKUP_FILE.gz" s3://your-backup-bucket/
```

Add to crontab:

```bash
# Daily backup at 2 AM
0 2 * * * /path/to/backup.sh
```

## Troubleshooting Production Issues

### Common Issues

**High Memory Usage**
- Check for connection leaks
- Monitor active connections: `SELECT count(*) FROM pg_stat_activity;`
- Implement connection pooling

**Slow Queries**
- Enable query logging
- Add database indexes
- Use `EXPLAIN ANALYZE` on slow queries

**CORS Errors**
- Verify production domains in CORS configuration
- Check HTTPS/HTTP protocol consistency

### Debugging Tools

```bash
# Check logs
docker-compose logs -f analytics

# Database connections
psql $DATABASE_URL -c "SELECT count(*) FROM pg_stat_activity;"

# API health
curl -v https://analytics.yourdomain.com/health

# Performance testing
ab -n 1000 -c 10 https://analytics.yourdomain.com/health
```

## Next Steps

<Cards>
  <Card title="Configuration" href="/docs/configuration" description="Environment variables and settings" />
  <Card title="Database Schema" href="/docs/database-schema" description="Database structure and optimization" />
  <Card title="Troubleshooting" href="/docs/troubleshooting" description="Common issues and solutions" />
  <Card title="Examples" href="/docs/examples" description="Production integration examples" />
</Cards>
